<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>רשימת מוצרים</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>רשימת מוצרים</h1>
    <form id="orderForm">
        <table>
            <thead>
                <tr>
                    <th>מוצר</th>
                    <th>מחיר</th>
                    <th>כמות</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td>{{ product.description }}</td>
                    <td>{{ product.price }} ₪</td>
                    <td>
                        <input type="number" name="product_{{ product.product_id }}" value="0" min="0" 
                               data-id="{{ product.product_id }}" 
                               data-description="{{ product.description }}" 
                               data-price="{{ product.price }}">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <label for="customer_name">שם המזמין:</label>
        <input type="text" id="customer_name" required>
        <button type="button" onclick="submitOrder()">שלח הזמנה</button>
    </form>

    <div id="orderConfirmation" style="display: none;">
        <h2>הזמנה בוצעה בהצלחה!</h2>
        <p><strong>שם המזמין:</strong> <span id="confirmName"></span></p>
        <p><strong>תאריך הזמנה:</strong> <span id="confirmDate"></span></p>
        <h3>פרטי ההזמנה:</h3>
        <ul id="confirmItems"></ul>
        <p><strong>סה"כ לתשלום:</strong> <span id="confirmTotal"></span> ₪</p>
    </div>

    <script>
        function submitOrder() {
            const customerName = document.getElementById('customer_name').value;
            const orderDate = new Date().toISOString().split('T')[0];
            const items = [];
            let totalPrice = 0;
            
            document.querySelectorAll('input[type=number]').forEach(input => {
                const quantity = parseInt(input.value, 10);
                if (quantity > 0) {
                    const product = {
                        product_id: input.getAttribute('data-id'),
                        description: input.getAttribute('data-description'),
                        quantity: quantity,
                        price: parseFloat(input.getAttribute('data-price'))
                    };
                    totalPrice += product.quantity * product.price;
                    items.push(product);
                }
            });

            if (items.length === 0 || !customerName) {
                alert('יש להזין שם ולבחור לפחות מוצר אחד');
                return;
            }

            const orderData = {
                customer_name: customerName,
                order_date: orderDate,
                items: items,
                total_price: totalPrice
            };

            fetch('/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('confirmName').innerText = data.order.customer_name;
                document.getElementById('confirmDate').innerText = data.order.order_date;
                document.getElementById('confirmTotal').innerText = data.order.total_price.toFixed(2);

                const itemsList = document.getElementById('confirmItems');
                itemsList.innerHTML = '';
                data.order.items.forEach(item => {
                    const li = document.createElement('li');
                    li.innerText = `${item.description} - כמות: ${item.quantity}, מחיר: ${item.price} ₪`;
                    itemsList.appendChild(li);
                });

                document.getElementById('orderConfirmation').style.display = 'block';
                document.getElementById('orderForm').reset();
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
